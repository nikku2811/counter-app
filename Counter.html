<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DIKSHA QR Redirect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<script>
  // ---------------------------------------------------------
  // ðŸ”§ Measurement Protocol config (Firebase GA4)
  // ---------------------------------------------------------
  const MEASUREMENT_ID = "G-2YE7FLMZ5P";        // your GA4 measurement ID
  const API_SECRET     = "Sh5hsJXKQEKydOmG9V0BbQ";     // create in Firebase â†’ Data streams
  const CLIENT_ID_KEY  = "qr_redirect_client_id";

  // ---------------------------------------------------------
  // ðŸ“± Store URLs
  // ---------------------------------------------------------
  const STORE_URLS = {
    ios: "https://apps.apple.com/in/app/diksha/id1587874277",
    android: "https://play.google.com/store/apps/details?id=in.gov.diksha.app&hl=en_IN",
    web: "https://diksha.gov.in"
  };

  // ---------------------------------------------------------
  // ðŸ§  Device detection
  // ---------------------------------------------------------
  function detectDevice() {
    const ua = navigator.userAgent || "";
    if (/iPhone|iPad|iPod/i.test(ua)) return "ios";
    if (/Android/i.test(ua)) return "android";
    //return "web";
  }

  // ---------------------------------------------------------
  // ðŸ†” Client ID (persisted) for GA4 MP
  // ---------------------------------------------------------
  function getClientId() {
    let cid = localStorage.getItem(CLIENT_ID_KEY);
    if (!cid) {
      cid = `${Date.now()}.${Math.floor(Math.random() * 1e9)}`;
      localStorage.setItem(CLIENT_ID_KEY, cid);
    }
    return cid;
  }

  // ---------------------------------------------------------
  // ðŸ“Š Build GA4 Measurement Protocol payload
  // ---------------------------------------------------------
  function buildPayload(device) {
    const client_id = getClientId();
    const ts = Date.now();

    return {
      client_id,
      events: [
        {
          name: "qr_scan_redirect",
          params: {
            device,
            source: "website_qr",
            ts,
            event_count:1
          }
        },
        {
          name: `qr_scan_redirect_${device}`,
          params: {
            source: "website_qr",
            ts,
            event_count:1
          }
        }
      ]
    };
  }

  // ---------------------------------------------------------
  // ðŸš€ Send event reliably (sendBeacon â†’ fetch keepalive fallback)
  // ---------------------------------------------------------
  function sendEvents(payload) {
    const url = `https://www.google-analytics.com/mp/collect?measurement_id=${encodeURIComponent(MEASUREMENT_ID)}&api_secret=${encodeURIComponent(API_SECRET)}`;
    const body = JSON.stringify(payload);

    // Prefer beacon for unload-safe delivery
    if (navigator.sendBeacon) {
      const ok = navigator.sendBeacon(url, body);
      if (ok) return Promise.resolve(true);
      // fall through to fetch if beacon fails
    }

    // Fallback: fetch with keepalive to survive navigation
    return fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body,
      keepalive: true
    }).then(() => true).catch(() => false);
  }

  // ---------------------------------------------------------
  // ðŸ” Track + redirect
  // ---------------------------------------------------------
  async function trackAndRedirect() {
    const device = detectDevice();
    const payload = buildPayload(device);

    // Fire events; donâ€™t block redirect forever
    try {
      await sendEvents(payload);
    } catch (_) {
      // swallow errorsâ€”redirect should still proceed
    }

    // Short delay (optional) to keep UX smooth
    const REDIRECT_DELAY_MS = 600;
    setTimeout(() => {
      const target = STORE_URLS[device] || STORE_URLS.web;
      window.location.replace(target);
    }, REDIRECT_DELAY_MS);
  }

  // ---------------------------------------------------------
  // ðŸŽ¯ Start on DOM ready
  // ---------------------------------------------------------
  document.addEventListener("DOMContentLoaded", trackAndRedirect);
</script>
</body>
</html>


